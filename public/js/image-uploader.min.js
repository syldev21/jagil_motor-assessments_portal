!function(e){e.fn.imageUploader=function(t){let a={preloaded:[],imagesInputName:"images",preloadedInputName:"preloaded",label:"Drag & Drop files here or click to browse"},n=this;n.settings={},n.init=function(){n.settings=e.extend(n.settings,a,t),n.each(function(t,a){let i=s();if(e(a).append(i),i.on("dragover",d.bind(i)),i.on("dragleave",d.bind(i)),i.on("drop",r.bind(i)),n.settings.preloaded.length){i.addClass("has-files");let e=i.find(".uploaded");for(let t=0;t<n.settings.preloaded.length;t++)e.append(l(n.settings.preloaded[t].src,n.settings.preloaded[t].id,!0))}})};let i=new DataTransfer,s=function(){let t=e("<div>",{class:"image-uploader"}),a=e("<input>",{type:"file",id:n.settings.imagesInputName+"-"+c(),name:n.settings.imagesInputName+"[]",multiple:""}).appendTo(t),i=(e("<div>",{class:"uploaded"}).appendTo(t),e("<div>",{class:"upload-text"}).appendTo(t));e("<i>",{class:"material-icons",text:"cloud_upload"}).appendTo(i),e("<span>",{text:n.settings.label}).appendTo(i);return t.on("click",function(e){o(e),a.trigger("click")}),a.on("click",function(e){e.stopPropagation()}),a.on("change",r.bind(t)),t},o=function(e){e.preventDefault(),e.stopPropagation()},l=function(t,a){let s=e("<div>",{class:"uploaded-image"}),l=(e("<img>",{src:t}).appendTo(s),e("<button>",{class:"delete-image"}).appendTo(s));e("<i>",{class:"material-icons",text:"clear"}).appendTo(l);if(n.settings.preloaded.length){s.attr("data-preloaded",!0);e("<input>",{type:"hidden",name:n.settings.preloadedInputName+"[]",value:a}).appendTo(s)}else s.attr("data-index",a);return s.on("click",function(e){o(e)}),l.on("click",function(t){o(t),t.preventDefault();var a=e(this).prev("img").attr("src").split("/").pop(),n=e("#assessmentID"),l=new FormData,d=e("#imagesArray").val(),r=JSON.parse(d),p=[];e(".uploaded-image img").each(function(){var e=this.src.split("/"),t=e[e.length-1];p.push(t)}),r=r.filter(function(e){return p.includes(e.name)});e("input[type=file]")[0].files.length,e("input[type=file]")[0];var c=[];if(e.each(r,function(e,t){!async function(){let e=await fetch("/documents/"+t.name),a=await e.blob(),n=new File([a],t.name,{type:"image/jpeg"});c.push(n)}()}),setTimeout(function(){var t=[],i=[];for(let e=0;e<c.length;e++){var s={name:c[e].name},o=c[e].name;t.push(s),i.push(o),console.log(c[e].name)}console.log(i),console.log(e.inArray(a,i)),l.append("assessmentID",n.val()),l.append("imageName",a),!e.inArray(a,i)>-1&&(e.ajaxSetup({headers:{"X-CSRF-TOKEN":e('meta[name="csrf-token"]').attr("content")}}),e.ajax({type:"POST",contentType:!1,processData:!1,data:l,url:"/assessor/deleteImage",success:function(t){var a=e.parseJSON(t);a.STATUS_CODE==SUCCESS_CODE||Swal.fire({icon:"error",title:a.STATUS_MESSAGE,showConfirmButton:!1,timer:3e3})}}))},1e3),s.data("index")){let t=parseInt(s.data("index"));s.find(".uploaded-image[data-index]").each(function(a,n){a>t&&e(n).attr("data-index",a-1)}),i.items.remove(t)}s.remove(),s.find(".uploaded-image").length||s.removeClass("has-files")}),s},d=function(t){o(t),"dragover"===t.type?e(this).addClass("drag-over"):e(this).removeClass("drag-over")},r=function(t){o(t);let a=e(this);a.removeClass("drag-over");let n=t.target.files||t.originalEvent.dataTransfer.files;p(a,n)},p=function(t,a){t.addClass("has-files");let n=t.find(".uploaded"),s=t.find('input[type="file"]');e(a).each(function(e,t){i.items.add(t),n.append(l(URL.createObjectURL(t),i.items.length-1))}),s.prop("files",i.files)},c=function(){return Date.now()+Math.floor(100*Math.random()+1)};return this.init(),this}}(jQuery);
